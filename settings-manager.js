// Settings Manager - My Connect AI
class SettingsManager {
    constructor() {
        this.isOpen = false;
        this.hasUnsavedChanges = false;
        this.currentTab = 'ai-models';
        
        // Reference na ostatn√≠ managery
        this.aiModels = null;
        this.appConnectors = null;
        this.uiManager = null;
        
        this.initializeManagers();
        this.setupEventListeners();
    }
    
    // Inicializace referenc√≠ na ostatn√≠ managery
    initializeManagers() {
        // Poƒçkat na naƒçten√≠ ostatn√≠ch manager≈Ø
        setTimeout(() => {
            this.aiModels = window.aiModelsManager;
            this.appConnectors = window.appConnectorsManager;
            this.uiManager = window.uiManager;
        }, 100);
    }
    
    // Nastavit event listenery
    setupEventListeners() {
        // Poslouchat zmƒõny v nastaven√≠
        document.addEventListener('change', (e) => {
            if (e.target.closest('.settings-panel')) {
                this.markAsChanged();
            }
        });
        
        // Poslouchat ESC kl√°vesy pro zav≈ôen√≠
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && this.isOpen) {
                this.toggle();
            }
        });
    }
    
    // Otev≈ô√≠t/zav≈ô√≠t nastaven√≠
    toggle() {
        const panel = document.getElementById('settings-panel');
        if (!panel) {
            console.error('Settings panel not found!');
            return;
        }
        
        this.isOpen = !this.isOpen;
        
        if (this.isOpen) {
            this.open();
        } else {
            this.close();
        }
    }
    
    // Otev≈ô√≠t nastaven√≠
    open() {
        const panel = document.getElementById('settings-panel');
        panel.style.display = 'block';
        this.isOpen = true;
        
        // Naƒç√≠st aktu√°ln√≠ hodnoty
        this.loadCurrentValues();
        
        // Aplikovat spr√°vn√© zobrazen√≠ AI modelu
        setTimeout(() => {
            this.updateAIModelDisplay();
        }, 50);
        
        console.log('‚öôÔ∏è Settings panel opened');
    }
    
    // Zav≈ô√≠t nastaven√≠
    close() {
        if (this.hasUnsavedChanges) {
            if (!confirm('M√°te neulo≈æen√© zmƒõny. Opravdu chcete zav≈ô√≠t nastaven√≠?')) {
                return false;
            }
        }
        
        const panel = document.getElementById('settings-panel');
        panel.style.display = 'none';
        this.isOpen = false;
        this.hasUnsavedChanges = false;
        
        console.log('‚öôÔ∏è Settings panel closed');
        return true;
    }
    
    // Naƒç√≠st aktu√°ln√≠ hodnoty do formul√°≈ôe
    loadCurrentValues() {
        // AI model selection
        const aiModelSelect = document.getElementById('ai-model-select');
        if (aiModelSelect && this.aiModels) {
            aiModelSelect.value = this.aiModels.getSelectedModel();
        }
        
        // API kl√≠ƒçe - vyƒçistit a nastavit placeholdery
        this.loadApiKeys();
        
        // App connectors
        this.loadAppConnectorValues();
        
        // Obecn√© nastaven√≠
        this.loadGeneralSettings();
    }
    
    // Naƒç√≠st API kl√≠ƒçe
    loadApiKeys() {
        const models = ['openai', 'gemini', 'claude'];
        
        models.forEach(model => {
            const field = document.getElementById(`${model}-key`);
            if (field) {
                const hasKey = !!(this.aiModels && this.aiModels.getApiKey(model));
                field.value = '';
                field.placeholder = hasKey ? 
                    'API kl√≠ƒç je nastaven (pro zmƒõnu zadejte nov√Ω)' : 
                    this.getDefaultPlaceholder(model);
            }
        });
    }
    
    // Z√≠skat v√Ωchoz√≠ placeholder pro model
    getDefaultPlaceholder(model) {
        const placeholders = {
            'openai': 'sk-...',
            'gemini': 'AIza...',
            'claude': 'sk-ant-...'
        };
        return placeholders[model] || 'API kl√≠ƒç';
    }
    
    // Naƒç√≠st hodnoty app konektor≈Ø
    loadAppConnectorValues() {
        // Tabidoo
        const tabidooToken = document.getElementById('tabidoo-token');
        const tabidooAppId = document.getElementById('tabidoo-app-id');
        
        if (tabidooToken) {
            const hasToken = !!(this.appConnectors && 
                this.appConnectors.checkConnectionStatus('tabidoo') === 'connected');
            tabidooToken.value = '';
            tabidooToken.placeholder = hasToken ? 
                'Token je nastaven (pro zmƒõnu zadejte nov√Ω)' : 'eyJ...';
        }
        
        if (tabidooAppId) {
            tabidooAppId.value = security.loadSecure('tabidoo_app_id') || '';
        }
        
        // Aktualizovat statusy
        this.updateAppStatuses();
    }
    
    // Naƒç√≠st obecn√© nastaven√≠
    loadGeneralSettings() {
        // Tema se naƒçte automaticky z UI manageru
        if (this.uiManager) {
            this.uiManager.updateThemeSelector();
        }
    }
    
    // Aktualizovat zobrazen√≠ AI modelu
    updateAIModelDisplay() {
        const selectedModel = document.getElementById('ai-model-select')?.value || 'openai';
        
        // Skr√Ωt v≈°echna nastaven√≠ AI model≈Ø
        document.querySelectorAll('.ai-model-settings').forEach(settings => {
            settings.style.display = 'none';
        });
        
        // Zobrazit vybran√© nastaven√≠
        const selectedSettings = document.getElementById(selectedModel + '-settings');
        if (selectedSettings) {
            selectedSettings.style.display = 'block';
        }
        
        console.log('ü§ñ AI model display updated:', selectedModel);
    }
    
    // Aktualizovat statusy aplikac√≠
    updateAppStatuses() {
        if (!this.appConnectors) return;
        
        const connectors = this.appConnectors.getAllConnectors();
        connectors.forEach(connector => {
            const statusElement = document.getElementById(`${connector.key}-status`);
            if (statusElement) {
                const statusText = this.appConnectors.getStatusText(connector.status);
                statusElement.textContent = statusText;
                statusElement.className = `app-connector-status ${connector.status.replace('_', '-')}`;
            }
        });
    }
    
    // Oznaƒçit jako zmƒõnƒõno
    markAsChanged() {
        this.hasUnsavedChanges = true;
        
        // Vizu√°ln√≠ indikace zmƒõn
        const saveButton = document.querySelector('.primary-btn');
        if (saveButton && !saveButton.classList.contains('has-changes')) {
            saveButton.classList.add('has-changes');
            saveButton.textContent = 'Ulo≈æit zmƒõny *';
        }
    }
    
    // Ulo≈æit v≈°echna nastaven√≠
    async save() {
        try {
            const results = {
                aiModel: await this.saveAIModelSettings(),
                appConnectors: await this.saveAppConnectorSettings(),
                general: await this.saveGeneralSettings()
            };
            
            this.hasUnsavedChanges = false;
            
            // Reset vizu√°ln√≠ch indikac√≠
            const saveButton = document.querySelector('.primary-btn');
            if (saveButton) {
                saveButton.classList.remove('has-changes');
                saveButton.textContent = 'Ulo≈æit nastaven√≠';
            }
            
            // Aktualizovat statusy
            this.updateAppStatuses();
            
            console.log('üíæ All settings saved:', results);
            
            // Zobrazit √∫spƒõ≈°nou zpr√°vu
            this.showSuccessMessage('Nastaven√≠ bylo √∫spƒõ≈°nƒõ ulo≈æeno!');
            
            // Zav≈ô√≠t panel
            setTimeout(() => this.close(), 1000);
            
            // Reload pokud je pot≈ôeba
            if (results.appConnectors.needsReload) {
                setTimeout(() => location.reload(), 1500);
            }
            
            return results;
            
        } catch (error) {
            console.error('‚ùå Error saving settings:', error);
            this.showErrorMessage(`Chyba p≈ôi ukl√°d√°n√≠: ${error.message}`);
            throw error;
        }
    }
    
    // Ulo≈æit nastaven√≠ AI model≈Ø
    async saveAIModelSettings() {
        const selectedModel = document.getElementById('ai-model-select')?.value;
        const results = { selectedModel, savedKeys: [] };
        
        if (selectedModel && this.aiModels) {
            this.aiModels.setSelectedModel(selectedModel);
            results.selectedModel = selectedModel;
        }
        
        // Ulo≈æit API kl√≠ƒçe
        const models = ['openai', 'gemini', 'claude'];
        for (const model of models) {
            const keyField = document.getElementById(`${model}-key`);
            if (keyField && keyField.value.trim()) {
                const apiKey = keyField.value.trim();
                if (this.aiModels && this.aiModels.saveApiKey(model, apiKey)) {
                    results.savedKeys.push(model);
                    console.log(`üîë ${model} API key saved`);
                }
            }
        }
        
        return results;
    }
    
    // Ulo≈æit nastaven√≠ app konektor≈Ø
    async saveAppConnectorSettings() {
        const results = { saved: [], needsReload: false };
        
        // Tabidoo
        const tabidooToken = document.getElementById('tabidoo-token')?.value.trim();
        const tabidooAppId = document.getElementById('tabidoo-app-id')?.value.trim();
        
        if (tabidooToken && tabidooAppId && this.appConnectors) {
            try {
                const result = await this.appConnectors.saveConnectorSettings('tabidoo', {
                    apiToken: tabidooToken,
                    appId: tabidooAppId
                });
                
                results.saved.push('tabidoo');
                results.needsReload = true;
                console.log('üìä Tabidoo settings saved:', result);
            } catch (error) {
                console.error('‚ùå Tabidoo save error:', error);
                throw new Error(`Tabidoo: ${error.message}`);
            }
        }
        
        return results;
    }
    
    // Ulo≈æit obecn√© nastaven√≠
    async saveGeneralSettings() {
        const results = {};
        
        // Barevn√© sch√©ma se ukl√°d√° automaticky p≈ôi zmƒõnƒõ
        if (this.uiManager) {
            results.theme = this.uiManager.getCurrentTheme();
        }
        
        return results;
    }
    
    // Zobrazit zpr√°vu o √∫spƒõchu
    showSuccessMessage(message) {
        this.showMessage(message, 'success');
    }
    
    // Zobrazit chybovou zpr√°vu
    showErrorMessage(message) {
        this.showMessage(message, 'error');
    }
    
    // Zobrazit zpr√°vu
    showMessage(message, type = 'info') {
        // Vytvo≈ô notifikaci
        const notification = document.createElement('div');
        notification.className = `settings-notification ${type}`;
        notification.textContent = message;
        
        // P≈ôidej do settings panelu
        const panel = document.getElementById('settings-panel');
        if (panel) {
            panel.insertBefore(notification, panel.firstChild);
            
            // Odstranit po 3 sekund√°ch
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 3000);
        }
    }
    
    // Export konfigurace
    exportConfiguration() {
        const config = {
            timestamp: new Date().toISOString(),
            version: '1.0',
            aiModels: this.aiModels ? {
                selected: this.aiModels.getSelectedModel(),
                available: this.aiModels.getAllModels().map(m => ({
                    key: m.key,
                    name: m.name,
                    hasApiKey: m.hasApiKey
                }))
            } : {},
            appConnectors: this.appConnectors ? this.appConnectors.exportConfiguration() : {},
            general: {
                theme: localStorage.getItem('selectedAppTheme') || 'claude'
            }
        };
        
        return config;
    }
    
    // Import konfigurace
    async importConfiguration(config) {
        try {
            if (config.aiModels && config.aiModels.selected) {
                localStorage.setItem('selected_ai_model', config.aiModels.selected);
            }
            
            if (config.general && config.general.theme) {
                localStorage.setItem('selectedAppTheme', config.general.theme);
            }
            
            console.log('üì• Configuration imported successfully');
            return true;
        } catch (error) {
            console.error('‚ùå Import error:', error);
            throw error;
        }
    }
    
    // Vymazat v≈°echna data
    clearAllData() {
        if (confirm('Opravdu chcete vymazat v≈°echna data vƒçetnƒõ API kl√≠ƒç≈Ø?\n\nTato akce je nevratn√°!')) {
            localStorage.clear();
            if (typeof security !== 'undefined' && security.clearSecure) {
                security.clearSecure();
            }
            
            alert('V≈°echna data byla vymaz√°na.');
            location.reload();
        }
    }
    
    // Diagnostika nastaven√≠
    async runDiagnostics() {
        const results = {
            timestamp: new Date().toISOString(),
            aiModels: {},
            appConnectors: {},
            general: {}
        };
        
        // AI Models diagnostika
        if (this.aiModels) {
            const models = this.aiModels.getAllModels();
            for (const model of models) {
                try {
                    if (model.hasApiKey) {
                        const testResult = await this.aiModels.testConnection(model.key);
                        results.aiModels[model.key] = {
                            name: model.name,
                            status: testResult.success ? 'ok' : 'error',
                            message: testResult.success ? 'P≈ôipojen√≠ OK' : testResult.error
                        };
                    } else {
                        results.aiModels[model.key] = {
                            name: model.name,
                            status: 'not_configured',
                            message: 'Nen√≠ nastaven API kl√≠ƒç'
                        };
                    }
                } catch (error) {
                    results.aiModels[model.key] = {
                        name: model.name,
                        status: 'error',
                        message: error.message
                    };
                }
            }
        }
        
        // App Connectors diagnostika
        if (this.appConnectors) {
            results.appConnectors = await this.appConnectors.runDiagnostics();
        }
        
        // Obecn√° diagnostika
        results.general = {
            theme: localStorage.getItem('selectedAppTheme') || 'claude',
            browser: navigator.userAgent,
            localStorage: typeof Storage !== 'undefined'
        };
        
        return results;
    }
}

// Glob√°ln√≠ instance
const settingsManager = new SettingsManager();

// Export pro ostatn√≠ moduly
if (typeof window !== 'undefined') {
    window.settingsManager = settingsManager;
}

// Glob√°ln√≠ funkce pro kompatibilitu
window.toggleSettings = () => settingsManager.toggle();
window.saveSettings = () => settingsManager.save();
window.clearAllData = () => settingsManager.clearAllData();
