<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tabidoo CRM Asistent | MELIORO Systems</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="wizard-styles.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ¤–</text></svg>">
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <div class="header-content">
                <h1>Tabidoo CRM Asistent</h1>
                <div class="header-subtitle">Powered by MELIORO Systems</div>
            </div>
            <div class="header-buttons">
                <button class="header-btn refresh-button" onclick="refreshData()" title="Obnovit data z Tabidoo">
                    ğŸ”„
                </button>
                <button class="header-btn settings-button" onclick="toggleSettings()" title="NastavenÃ­">
                    âš™ï¸
                </button>
                <button class="header-btn diagnostic-button" onclick="runDiagnosticsManual()" title="Diagnostika">
                    ğŸ”§
                </button>
                <button class="header-btn wizard-button" onclick="startSetupWizard()" title="Nastavit novou aplikaci">
                    ğŸ§™â€â™‚ï¸
                </button>
            </div>
        </div>
        
        <div id="settings-panel" class="settings-panel" style="display: none;">
            <div class="settings-title">
                <span>ğŸ”</span>
                <span>ZabezpeÄenÃ© nastavenÃ­ API</span>
            </div>
            
            <div class="settings-section">
                <label for="openai-key">OpenAI API klÃ­Ä:</label>
                <div class="input-group">
                    <input type="password" id="openai-key" placeholder="sk-...">
                    <button onclick="toggleVisibility('openai-key')" class="toggle-btn">ğŸ‘ï¸</button>
                </div>
                <small>ZÃ­skejte na <a href="https://platform.openai.com/api-keys" target="_blank">platform.openai.com</a></small>
            </div>
            
            <div class="settings-section">
                <label for="tabidoo-token">Tabidoo API token:</label>
                <div class="input-group">
                    <input type="password" id="tabidoo-token" placeholder="eyJ...">
                    <button onclick="toggleVisibility('tabidoo-token')" class="toggle-btn">ğŸ‘ï¸</button>
                </div>
                <small>Najdete v Tabidoo â†’ NastavenÃ­ â†’ API</small>
            </div>
            
            <div class="settings-section">
                <label for="tabidoo-app-id">Tabidoo App ID:</label>
                <input type="text" id="tabidoo-app-id" placeholder="CRM Start">
                <small>NÃ¡zev vaÅ¡Ã­ aplikace v Tabidoo</small>
            </div>
            
            <div class="settings-actions">
                <button onclick="saveSettings()" class="primary-btn">ğŸ’¾ UloÅ¾it nastavenÃ­</button>
                <button onclick="toggleSettings()" class="secondary-btn">ZruÅ¡it</button>
            </div>
            
            <div class="settings-footer">
                <button onclick="exportConfig()" class="link-btn">ğŸ“¤ Export konfigurace</button>
                <button onclick="importConfig()" class="link-btn">ğŸ“¥ Import konfigurace</button>
                <button onclick="clearAllData()" class="link-btn danger">ğŸ—‘ï¸ Vymazat vÅ¡e</button>
            </div>
            
            <div class="security-info">
                ğŸ”’ VÅ¡echny API klÃ­Äe jsou Å¡ifrovÃ¡ny a uklÃ¡dÃ¡ny pouze lokÃ¡lnÄ› ve vaÅ¡em prohlÃ­Å¾eÄi.
            </div>
        </div>
        
        <div id="embeddings-status" class="embeddings-status" style="display: none;">
            <span id="embeddings-text">VytvÃ¡Å™Ã­m vyhledÃ¡vacÃ­ index...</span>
            <div class="progress-bar">
                <div id="embeddings-progress" class="progress-fill"></div>
            </div>
        </div>
        
        <div id="chat-messages" class="chat-messages">
            <div class="welcome-container">
                <div class="welcome-title">VÃ­tejte v Tabidoo CRM Asistentovi</div>
                <div class="welcome-subtitle">InteligentnÃ­ asistent pro prÃ¡ci s vaÅ¡imi CRM daty</div>
                
                <div class="example-queries" id="example-queries">
                    <!-- PÅ™Ã­klady budou naÄteny dynamicky -->
                </div>
            </div>
        </div>
        
        <div class="chat-input-area">
            <textarea id="chat-input" class="chat-input" placeholder="Zeptejte se na cokoliv o vaÅ¡ich datech..." rows="1"></textarea>
            <button id="send-button" class="send-button" onclick="sendMessage()">
                <span>Odeslat</span>
                <span>â†—ï¸</span>
            </button>
        </div>
    </div>

    <!-- NaÄtenÃ­ POUZE existujÃ­cÃ­ch skriptÅ¯ -->
    <script src="security.js"></script>
    <script src="config.js"></script>
    <script src="display.js"></script>
    <script src="data-loader.js"></script>
    <script src="local-search.js"></script>
    <script src="query-processor.js"></script>
    <script src="setup-wizard.js"></script>
    <script src="wizard-integration.js"></script>
    <script src="main.js"></script>
    
    <script>
        // PomocnÃ© funkce
        function toggleVisibility(fieldId) {
            const field = document.getElementById(fieldId);
            field.type = field.type === 'password' ? 'text' : 'password';
        }
        
        function clearAllData() {
            if (confirm('Opravdu chcete vymazat vÅ¡echna data vÄetnÄ› API klÃ­ÄÅ¯?\n\nTato akce je nevratnÃ¡!')) {
                localStorage.clear();
                alert('VÅ¡echna data byla vymazÃ¡na.');
                location.reload();
            }
        }
        
        // ManuÃ¡lnÃ­ spuÅ¡tÄ›nÃ­ diagnostiky
        function runDiagnosticsManual() {
            localStorage.removeItem(CONFIG.CACHE.DIAGNOSTICS_KEY);
            location.reload();
        }
        
        // KlikacÃ­ pÅ™Ã­klady dotazÅ¯
        function clickExampleQuery(query) {
            const chatInput = document.getElementById('chat-input');
            chatInput.value = query;
            chatInput.focus();
            
            // Auto-resize textarea
            chatInput.style.height = 'auto';
            chatInput.style.height = chatInput.scrollHeight + 'px';
        }
        
        // NaÄtenÃ­ pÅ™Ã­kladÅ¯ dotazÅ¯
        function loadExampleQueries() {
            const exampleQueriesContainer = document.getElementById('example-queries');
            if (!exampleQueriesContainer) return;
            
            const examples = CONFIG.EXAMPLE_QUERIES || [
                { icon: 'ğŸ“Š', text: 'Kolik firem je v systÃ©mu?' },
                { icon: 'ğŸ“‹', text: 'VypiÅ¡ vÅ¡echny firmy' },
                { icon: 'ğŸ”', text: 'Najdi firmu Alza' },
                { icon: 'ğŸ‘¥', text: 'Kolik kontaktÅ¯ mÃ¡me?' },
                { icon: 'ğŸ’¼', text: 'VypiÅ¡ obchodnÃ­ pÅ™Ã­pady' },
                { icon: 'ğŸ“ˆ', text: 'Kolik aktivit probÄ›hlo?' }
            ];
            
            exampleQueriesContainer.innerHTML = examples.map(example => `
                <div class="example-query" onclick="clickExampleQuery('${example.text}')">
                    <span class="example-query-icon">${example.icon}</span>
                    ${example.text}
                </div>
            `).join('');
        }
        
        // Auto-resize textarea
        function setupAutoResize() {
            const chatInput = document.getElementById('chat-input');
            if (!chatInput) return;
            
            chatInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });
            
            // Enter pro odeslÃ¡nÃ­, Shift+Enter pro novÃ½ Å™Ã¡dek
            chatInput.addEventListener('keydown', function(event) {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    sendMessage();
                }
            });
        }
        
        // Inicializace UI enhancements
        document.addEventListener('DOMContentLoaded', function() {
            loadExampleQueries();
            setupAutoResize();
        });
        
        // SkrytÃ­ welcome screen pÅ™i prvnÃ­ zprÃ¡vÄ›
        function hideWelcomeScreen() {
            const welcomeContainer = document.querySelector('.welcome-container');
            if (welcomeContainer) {
                welcomeContainer.style.display = 'none';
            }
        }
        
        // DEBUG: Override addMessage s blokem problematickÃ© zprÃ¡vy
        const originalAddMessage = window.addMessage;
        if (originalAddMessage) {
            window.addMessage = function(role, content) {
                // DEBUG: Zachytit a ZABLOKOVAT problematickou zprÃ¡vu
                if (content && content.includes('ğŸ¯ NovÃ½ hybridnÃ­ systÃ©m')) {
                    console.error('ğŸš¨ NALEZENA A ZABLOKOVÃNA PROBLEMATICKÃ ZPRÃVA!');
                    console.error('Role:', role);
                    console.error('Content preview:', content.substring(0, 100));
                    console.trace('Stack trace:');
                    
                    // BLOKOVAT tuto zprÃ¡vu - NEPOSÃLAT DÃLE
                    console.log('ğŸ›‘ Message blocked - not adding to chat');
                    return;
                }
                
                if (role === 'user' || role === 'assistant') {
                    hideWelcomeScreen();
                }
                return originalAddMessage(role, content);
            };
        }
    </script>
</body>
</html>
