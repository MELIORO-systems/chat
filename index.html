<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tabidoo CRM Asistent | MELIORO Systems</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="wizard-styles.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü§ñ</text></svg>">
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <div class="header-content">
                <h1>Tabidoo CRM Asistent</h1>
                <div class="header-subtitle">Hybridn√≠ AI syst√©m je p≈ôipraven k pou≈æit√≠</div>
            </div>
            <div class="header-buttons">
                <div class="dropdown">
                    <button class="menu-button" onclick="toggleMainMenu()">
                        Menu
                    </button>
                    <div class="dropdown-content" id="mainMenu">
                        <button class="dropdown-item" onclick="refreshData(); closeMainMenu();">
                            Obnovit data
                        </button>
                        <button class="dropdown-item" onclick="toggleSettings(); closeMainMenu();">
                            Nastaven√≠
                        </button>
                        <button class="dropdown-item" onclick="runDiagnosticsManual(); closeMainMenu();">
                            Diagnostika
                        </button>
                        <button class="dropdown-item" onclick="showSystemHelp(); closeMainMenu();">
                            Jak syst√©m funguje
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="settings-panel" class="settings-panel" style="display: none;">
            <div class="settings-title">Nastaven√≠ API</div>
            
            <div class="settings-section">
                <label for="openai-key">OpenAI API kl√≠ƒç</label>
                <div class="input-group">
                    <input type="password" id="openai-key" placeholder="sk-...">
                    <button onclick="toggleVisibility('openai-key')" class="toggle-btn">Zobrazit</button>
                </div>
                <small>Z√≠skejte na <a href="https://platform.openai.com/api-keys" target="_blank">platform.openai.com</a></small>
            </div>
            
            <div class="settings-section">
                <label for="tabidoo-token">Tabidoo API token</label>
                <div class="input-group">
                    <input type="password" id="tabidoo-token" placeholder="eyJ...">
                    <button onclick="toggleVisibility('tabidoo-token')" class="toggle-btn">Zobrazit</button>
                </div>
                <small>Najdete v Tabidoo ‚Üí Nastaven√≠ ‚Üí API</small>
            </div>
            
            <div class="settings-section">
                <label for="tabidoo-app-id">Tabidoo App ID</label>
                <input type="text" id="tabidoo-app-id" placeholder="CRM Start">
                <small>N√°zev va≈°√≠ aplikace v Tabidoo</small>
            </div>

            <div class="settings-section">
                <label>Barevn√© sch√©ma</label>
                <div class="theme-selector">
                    <div class="theme-option theme-claude active" onclick="setAppTheme('claude')" title="Claude (v√Ωchoz√≠)"></div>
                    <div class="theme-option theme-google" onclick="setAppTheme('google')" title="Google"></div>
                    <div class="theme-option theme-replit" onclick="setAppTheme('replit')" title="Replit"></div>
                </div>
                <small>Vyberte barevn√© sch√©ma rozhran√≠</small>
            </div>
            
            <div class="settings-actions">
                <button onclick="saveSettings()" class="primary-btn">Ulo≈æit nastaven√≠</button>
                <button onclick="toggleSettings()" class="secondary-btn">Zru≈°it</button>
            </div>
            
            <div class="security-info">
                V≈°echny API kl√≠ƒçe jsou ≈°ifrov√°ny a ukl√°d√°ny pouze lok√°lnƒõ ve va≈°em prohl√≠≈æeƒçi.
            </div>
        </div>
        
        <div id="embeddings-status" class="embeddings-status" style="display: none;">
            <span id="embeddings-text">Vytv√°≈ô√≠m vyhled√°vac√≠ index...</span>
            <div class="progress-bar">
                <div id="embeddings-progress" class="progress-fill"></div>
            </div>
        </div>
        
        <div id="chat-messages" class="chat-messages">
            <div class="welcome-container">
                <div class="example-queries" id="example-queries">
                    <!-- P≈ô√≠klady budou naƒçteny dynamicky -->
                </div>
            </div>
        </div>
        
        <div class="chat-input-area" id="chat-input-area">
            <textarea id="chat-input" class="chat-input" placeholder="Zeptejte se na cokoliv o va≈°ich datech..." rows="1"></textarea>
            <button id="send-button" class="send-button" onclick="sendMessage()">
                Odeslat
            </button>
        </div>
    </div>

    <!-- Naƒçten√≠ POUZE existuj√≠c√≠ch skript≈Ø -->
    <script src="security.js"></script>
    <script src="config.js"></script>
    <script src="display.js"></script>
    <script src="data-loader.js"></script>
    <script src="local-search.js"></script>
    <script src="query-processor.js"></script>
    <script src="setup-wizard.js"></script>
    <script src="wizard-integration.js"></script>
    <script src="main.js"></script>
    
    <script>
        // === THEME MANAGEMENT ===
        function setAppTheme(theme) {
            document.body.classList.remove('theme-claude', 'theme-google', 'theme-replit');
            
            if (theme !== 'claude') {
                document.body.classList.add('theme-' + theme);
            }
            
            localStorage.setItem('selectedAppTheme', theme);
            
            document.querySelectorAll('.theme-option').forEach(option => {
                option.classList.remove('active');
            });
            const activeOption = document.querySelector('.theme-' + theme);
            if (activeOption) {
                activeOption.classList.add('active');
            }
        }

        function loadAppTheme() {
            const savedTheme = localStorage.getItem('selectedAppTheme') || 'claude';
            setAppTheme(savedTheme);
        }

        // === MENU MANAGEMENT ===
        function toggleMainMenu() {
            const dropdown = document.getElementById('mainMenu');
            if (dropdown) {
                dropdown.classList.toggle('show');
            }
        }

        function closeMainMenu() {
            const dropdown = document.getElementById('mainMenu');
            if (dropdown) {
                dropdown.classList.remove('show');
            }
        }

        // Close menu when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.matches('.menu-button') && !event.target.closest('.dropdown')) {
                const dropdowns = document.getElementsByClassName('dropdown-content');
                for (let dropdown of dropdowns) {
                    if (dropdown.classList.contains('show')) {
                        dropdown.classList.remove('show');
                    }
                }
            }
        });

        // === HELPER FUNCTIONS ===
        function toggleVisibility(fieldId) {
            const field = document.getElementById(fieldId);
            if (!field) return;
            
            const button = field.parentNode.querySelector('.toggle-btn');
            if (field.type === 'password') {
                field.type = 'text';
                if (button) button.textContent = 'Skr√Ωt';
            } else {
                field.type = 'password';
                if (button) button.textContent = 'Zobrazit';
            }
        }
        
        // Enhanced toggleSettings to ensure footer buttons are added
        function toggleSettings() {
            const panel = document.getElementById('settings-panel');
            if (!panel) {
                console.error('Settings panel not found!');
                return;
            }
            
            const isHidden = panel.style.display === 'none' || !panel.style.display;
            
            if (isHidden) {
                panel.style.display = 'block';
                
                // FORCE create footer buttons every time settings open
                setTimeout(() => {
                    forceCreateSettingsFooter();
                }, 50);
            } else {
                panel.style.display = 'none';
            }
        }
        
        // Function to FORCE create settings footer buttons
        function forceCreateSettingsFooter() {
            const panel = document.getElementById('settings-panel');
            if (!panel) return;
            
            // Remove existing footer if it exists
            let existingFooter = panel.querySelector('.settings-footer');
            if (existingFooter) {
                existingFooter.remove();
            }
            
            // Find security info or create insertion point
            let securityInfo = panel.querySelector('.security-info');
            
            // Create new footer
            const footer = document.createElement('div');
            footer.className = 'settings-footer';
            footer.innerHTML = `
                <button onclick="startSetupWizard(); toggleSettings();" class="link-btn">Nastaven√≠ nov√© aplikace</button>
                <button onclick="exportConfig()" class="link-btn">Export konfigurace</button>
                <button onclick="importConfig()" class="link-btn">Import konfigurace</button>
                <button onclick="clearAllData()" class="link-btn danger">Vymazat v≈°e</button>
            `;
            
            if (securityInfo) {
                // Insert before security info
                securityInfo.parentNode.insertBefore(footer, securityInfo);
            } else {
                // Just append to panel
                panel.appendChild(footer);
                
                // Also create security info if it doesn't exist
                const securityDiv = document.createElement('div');
                securityDiv.className = 'security-info';
                securityDiv.textContent = 'V≈°echny API kl√≠ƒçe jsou ≈°ifrov√°ny a ukl√°d√°ny pouze lok√°lnƒõ ve va≈°em prohl√≠≈æeƒçi.';
                panel.appendChild(securityDiv);
            }
            
            console.log('üîß Settings footer forcefully created');
        }
        
        // Override toggleSettings globally IMMEDIATELY
        window.toggleSettings = toggleSettings;
        
        function clearAllData() {
            if (confirm('Opravdu chcete vymazat v≈°echna data vƒçetnƒõ API kl√≠ƒç≈Ø?\n\nTato akce je nevratn√°!')) {
                localStorage.clear();
                alert('V≈°echna data byla vymaz√°na.');
                location.reload();
            }
        }
        
        function runDiagnosticsManual() {
            if (typeof CONFIG !== 'undefined' && CONFIG.CACHE && CONFIG.CACHE.DIAGNOSTICS_KEY) {
                localStorage.removeItem(CONFIG.CACHE.DIAGNOSTICS_KEY);
            }
            location.reload();
        }
        
        // === EXAMPLE QUERIES ===
        function loadExampleQueries() {
            const exampleQueriesContainer = document.getElementById('example-queries');
            if (!exampleQueriesContainer) return;
            
            let examples = [];
            if (typeof CONFIG !== 'undefined' && CONFIG.EXAMPLE_QUERIES) {
                examples = CONFIG.EXAMPLE_QUERIES;
            } else {
                examples = [
                    { text: 'Kolik firem je v syst√©mu?' },
                    { text: 'Vypi≈° v≈°echny firmy' },
                    { text: 'Najdi firmu Alza' },
                    { text: 'Kolik kontakt≈Ø m√°me?' },
                    { text: 'Vypi≈° obchodn√≠ p≈ô√≠pady' },
                    { text: 'Kolik aktivit probƒõhlo?' }
                ];
            }
            
            exampleQueriesContainer.innerHTML = examples.map(example => `
                <div class="example-query" onclick="clickExampleQuery('${example.text.replace(/'/g, "\\'")}')">
                    ${example.text}
                </div>
            `).join('');
        }
        
        function clickExampleQuery(query) {
            const chatInput = document.getElementById('chat-input');
            if (!chatInput) return;
            
            chatInput.value = query;
            chatInput.focus();
            
            chatInput.style.height = 'auto';
            chatInput.style.height = Math.min(chatInput.scrollHeight, 120) + 'px';
            
            if (typeof hideWelcomeScreen === 'function') {
                hideWelcomeScreen();
            }
        }
        
        // === AUTO-RESIZE TEXTAREA ===
        function setupAutoResize() {
            const chatInput = document.getElementById('chat-input');
            if (!chatInput) return;
            
            chatInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });
            
            chatInput.addEventListener('keydown', function(event) {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    if (typeof sendMessage === 'function') {
                        sendMessage();
                    }
                }
            });
        }
        
        // === ENHANCED SYSTEM HELP ===
        function showSystemHelp() {
            const chatMessages = document.getElementById('chat-messages');
            if (!chatMessages) return;
            
            const helpContent = `
                <div class="system-help">
                    <div class="help-header">
                        <h3>Jak syst√©m funguje</h3>
                        <button class="help-close-btn" onclick="showWelcomeScreen()">&times;</button>
                    </div>
                    
                    <div class="help-content">
                        <div class="help-section">
                            <h4>Hybridn√≠ AI p≈ô√≠stup</h4>
                            <p>Kombinuje rychl√© lok√°ln√≠ vyhled√°v√°n√≠ s inteligentn√≠ AI komunikac√≠. 
                            Va≈°e data zpracov√°v√°m lok√°lnƒõ pro rychlost a p≈ôesnost, ChatGPT pou≈æ√≠v√°m jen pro formulaci odpovƒõd√≠.</p>
                        </div>
                        
                        <div class="help-section">
                            <h4>Kl√≠ƒçov√© v√Ωhody</h4>
                            <ul class="help-list">
                                <li>Okam≈æit√© odpovƒõdi bez ƒçek√°n√≠ na API</li>
                                <li>100% p≈ôesnost p≈ôi poƒç√≠t√°n√≠ z√°znam≈Ø</li>
                                <li>Inteligentn√≠ rozpozn√°v√°n√≠ r≈Øzn√Ωch tvar≈Ø slov</li>
                                <li>Chytr√© vyhled√°v√°n√≠ nez√°visl√© na velikosti p√≠smen</li>
                            </ul>
                        </div>
                        
                        <div class="help-section">
                            <h4>Co um√≠m</h4>
                            <ul class="help-list">
                                <li>Poƒç√≠tat z√°znamy - "Kolik firem m√°me?"</li>
                                <li>Vypisovat seznamy - "Vypi≈° v≈°echny kontakty"</li>
                                <li>Vyhled√°vat konkr√©tn√≠ z√°znamy - "Najdi firmu XYZ"</li>
                                <li>Naj√≠t souvisej√≠c√≠ informace - "Jak√© aktivity m√° firma ABC?"</li>
                            </ul>
                        </div>
                    </div>
                </div>
            `;
            
            chatMessages.innerHTML = helpContent;
        }
        
        // === ENHANCED WIZARD FUNCTIONS ===
        
        // Override startSetupWizard to add cancel functionality and close settings
        const originalStartSetupWizard = window.startSetupWizard;
        if (originalStartSetupWizard) {
            window.startSetupWizard = function() {
                // Close settings panel first
                const settingsPanel = document.getElementById('settings-panel');
                if (settingsPanel && settingsPanel.style.display !== 'none') {
                    settingsPanel.style.display = 'none';
                }
                
                // Store reference that wizard was started from settings
                sessionStorage.setItem('wizardStartedFromSettings', 'true');
                return originalStartSetupWizard();
            };
        } else {
            // If original function doesn't exist yet, create wrapper
            window.startSetupWizard = function() {
                // Close settings panel first
                const settingsPanel = document.getElementById('settings-panel');
                if (settingsPanel && settingsPanel.style.display !== 'none') {
                    settingsPanel.style.display = 'none';
                }
                
                sessionStorage.setItem('wizardStartedFromSettings', 'true');
                
                // Try to call the wizard if it exists
                if (typeof setupWizard !== 'undefined' && setupWizard.start) {
                    setupWizard.start();
                } else {
                    alert('Pr≈Øvodce nastaven√≠m nen√≠ dostupn√Ω. Zkuste obnovit str√°nku.');
                }
            };
        }
        
        // Add cancel wizard function
        function cancelSetupWizard() {
            if (confirm('Opravdu chcete zru≈°it pr≈Øvodce nastaven√≠m?')) {
                sessionStorage.removeItem('wizardStartedFromSettings');
                // Return to normal state
                if (typeof showWelcomeScreen === 'function') {
                    showWelcomeScreen();
                } else {
                    location.reload();
                }
            }
        }
        
        // Make cancel function globally available
        window.cancelSetupWizard = cancelSetupWizard;
        
        // === INTEGRATION WITH EXISTING SYSTEM ===
        
        // FORCE override showWelcomeScreen AFTER all scripts load
        function forceCorrectWelcomeScreen() {
            const chatMessages = document.getElementById('chat-messages');
            if (!chatMessages) return;
            
            chatMessages.innerHTML = `
                <div class="welcome-container">
                    <div class="example-queries" id="example-queries">
                        <!-- P≈ô√≠klady budou naƒçteny dynamicky -->
                    </div>
                </div>
            `;
            
            // Load example queries immediately
            loadExampleQueries();
        }
        
        // Override the function MULTIPLE times to ensure it sticks
        window.showWelcomeScreen = forceCorrectWelcomeScreen;
        
        // Watch for any attempts to change welcome screen content
        let welcomeObserver;
        function startWelcomeScreenProtection() {
            const chatMessages = document.getElementById('chat-messages');
            if (!chatMessages) return;
            
            // Disconnect existing observer
            if (welcomeObserver) {
                welcomeObserver.disconnect();
            }
            
            // Create new observer to watch for unwanted changes
            welcomeObserver = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'childList') {
                        const welcomeContainer = chatMessages.querySelector('.welcome-container');
                        if (welcomeContainer) {
                            // Check if unwanted buttons were added
                            const actionButtons = welcomeContainer.querySelector('.welcome-actions, .help-btn, .examples-btn');
                            if (actionButtons) {
                                console.log('üõ°Ô∏è Blocking unwanted welcome buttons');
                                forceCorrectWelcomeScreen();
                            }
                        }
                    }
                });
            });
            
            welcomeObserver.observe(chatMessages, {
                childList: true,
                subtree: true
            });
        }
        
        // === INITIALIZATION ===
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üé® Enhanced UI initializing...');
            
            loadAppTheme();
            setupAutoResize();
            
            // Override toggleSettings immediately
            window.toggleSettings = toggleSettings;
            
            // Start protection and force correct welcome screen
            setTimeout(() => {
                startWelcomeScreenProtection();
                forceCorrectWelcomeScreen();
            }, 100);
            
            console.log('üé® Enhanced UI ready');
        });
        
        // Fallback for already loaded DOM
        if (document.readyState !== 'loading') {
            setTimeout(() => {
                loadAppTheme();
                setupAutoResize();
                window.toggleSettings = toggleSettings;
                startWelcomeScreenProtection();
                forceCorrectWelcomeScreen();
            }, 200);
        }
        
        // ALSO override toggleSettings after all scripts load
        setTimeout(() => {
            window.toggleSettings = toggleSettings;
            console.log('üîß toggleSettings override applied');
        }, 3000);
        
        // AGGRESSIVE override - keep overriding the function every 100ms for 2 seconds
        let overrideAttempts = 0;
        const maxOverrideAttempts = 20;
        
        const overrideInterval = setInterval(() => {
            if (overrideAttempts >= maxOverrideAttempts) {
                clearInterval(overrideInterval);
                return;
            }
            
            window.showWelcomeScreen = forceCorrectWelcomeScreen;
            window.loadExampleQueries = loadExampleQueries;
            overrideAttempts++;
            
            // Also force correct display if chat-messages exists
            const chatMessages = document.getElementById('chat-messages');
            if (chatMessages && chatMessages.innerHTML.includes('welcome-actions')) {
                console.log('üõ°Ô∏è Detected unwanted buttons, forcing correct display');
                forceCorrectWelcomeScreen();
            }
        }, 100);
        
        // === COMPATIBILITY CHECKS ===
        setTimeout(() => {
            const requiredFunctions = [
                'sendMessage', 'saveSettings', 
                'refreshData', 'startSetupWizard', 'exportConfig', 
                'importConfig'
            ];
            
            const missingFunctions = requiredFunctions.filter(fn => typeof window[fn] !== 'function');
            
            if (missingFunctions.length > 0) {
                console.warn('‚ö†Ô∏è Missing functions:', missingFunctions);
            } else {
                console.log('‚úÖ All required functions available');
            }
            
            if (typeof CONFIG === 'undefined') {
                console.warn('‚ö†Ô∏è CONFIG object not found');
            } else {
                console.log('‚úÖ CONFIG loaded');
            }
            
            // Check current state
            const settingsPanel = document.getElementById('settings-panel');
            if (settingsPanel) {
                console.log('‚úÖ Settings panel found');
                console.log('üí° To see footer buttons, click "Nastaven√≠" in the menu');
            } else {
                console.warn('‚ö†Ô∏è Settings panel not found');
            }
            
            // Confirm toggleSettings override
            if (window.toggleSettings === toggleSettings) {
                console.log('‚úÖ toggleSettings successfully overridden');
            } else {
                console.warn('‚ö†Ô∏è toggleSettings override failed, trying again...');
                window.toggleSettings = toggleSettings;
            }
        }, 4000); // Wait even longer for all scripts to load
    </script>
</body>
</html>
